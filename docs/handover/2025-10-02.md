## kotobalint 引継ぎ資料 (2025/10/02)

### 今日のサマリ
- **textlint統合完了**: 3段階プリセット（Light/Standard/Strict）で計58ルールを実装
- **LLM rationale トリミング**: プロンプト改善で1-2文に制限し、レスポンスサイズ削減
- **新API `/api/analyze`**: ルールベースのテキスト解析エンドポイント追加

### うまくいった点
#### 1. textlintプリセットシステム
- ✅ **Light プリセット** (8ルール): ら抜き言葉、助詞重複を <1秒 で検出
- ✅ **Standard プリセット** (18ルール): 文体統一、冗長表現を 1-3秒 で検出
- ✅ **Strict プリセット** (32ルール): カタカナ表記、細かい表現を 3-5秒 で検出
- ✅ YAMLベース設定で柔軟な拡張が可能
- ✅ 実運用事例（Zenn, SmartHR）を参考にパフォーマンス最適化

#### 2. アーキテクチャ設計
- `PresetLoader`: YAML読み込み + 正規表現コンパイル + キャッシング
- `RuleEngine`: 既存のエンジンをそのまま活用
- API設計: GET で情報取得、POST で解析実行
- 文字エンコーディング: UTF-8対応（curl の charset 指定が必要）

#### 3. テスト検証
```bash
# Light: ら抜き言葉検出
curl -X POST http://localhost:3001/api/analyze \
  -H "Content-Type: application/json; charset=UTF-8" \
  -d '{"text":"これは食べれるテストです。","preset":"light"}'
# → 「食べれる」を検出、「食べられる」に修正提案

# Strict: カタカナ長音表記統一
curl -X POST http://localhost:3001/api/analyze \
  -H "Content-Type: application/json; charset=UTF-8" \
  -d '{"text":"コンピュータとユーザ","preset":"strict"}'
# → 「コンピューター」「ユーザー」に修正提案
```

### ブランチ戦略
- `master`: 安定版（rationale トリミング実装まで）
- `feature/llm-only-improvements`: LLM専用改善（未着手）
- `feature/textlint-integration`: textlint統合（✅ 完了・コミット済み）

### 次回やること
#### 優先度高
1. **UIへのプリセット選択機能追加**
   - フロントエンドで Light/Standard/Strict を選べるように
   - `/api/analyze` と `/api/suggest` (LLM) の切り替えUI

2. **パフォーマンス測定**
   - 実際の長文（1000文字）での処理時間計測
   - メモリ使用量のプロファイリング

#### 優先度中
3. **Phase 2 ルール追加** (20ルール候補)
   - `ja-no-inappropriate-words`: 不適切語チェック
   - `ja-space-between-half-and-full-width`: スペース整形
   - `prefer-tari-tari`: 〜たり〜たり構文

4. **ログ整備**
   - requestId・elapsedMs の統一出力
   - プリセット選択状況の記録

### 主要ファイル
#### 新規作成
- `src/rules/presets/*.yaml`: Light/Standard/Strict プリセット定義
- `src/lib/preset-loader.ts`: プリセット読み込みシステム
- `src/app/api/analyze/route.ts`: ルールベース解析API
- `docs/textlint-integration.md`: 統合ガイド（58ルール詳細）

#### 既存変更
- `src/lib/gemini-client.ts`: rationale トリミング指示追加
- `src/app/api/suggest/route.ts`: LLM提案API（既存）
- `src/lib/rule-engine.ts`: プリセット対応（変更なし・互換性維持）

### 技術的な学び
- **textlintの実運用事例**が貴重（誤検知対策、パフォーマンス優先）
- 全ルール適用より**段階的プリセット**が実用的
- 形態素解析系ルールは重いので**パターンマッチング優先**
- curlでのUTF-8テストには `charset=UTF-8` 必須
