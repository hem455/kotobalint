## kotobalint 引継ぎ資料 (2025/10/03)

### 今日のサマリ
- **助詞重複検出の精度向上**: 「ということ」などの自然表現を例外リストで除外
- **助詞「と」の検出除外**: 列挙表現（「AとBとC」）で頻出するため検出対象から削除
- **UI改善（ハイライト問題解決）**: 全issue常時表示 → 選択issueのみ表示に変更
- **UI改善（メタデータ整理）**: 内部用 `originalText` フィールドを非表示化
- **UI改善（自動スクロール）**: issueクリック時に該当箇所へスムーズスクロール
- **連続空白ルール削除**: 改行にも反応してしまうため Standard プリセットから削除
- **ヘッダーUI刷新**: ラジオボタン → モダンなタブUI、2段レイアウトで整理
- **モード別ボタン表示**: LLMモード時は「AI提案」、ルールベース時は「解析実行」
- **LLM issue管理改善**: maxIssues制限緩和（10→30）、重複issue問題を修正
- **🎉 アプリ初版完成**: 基本機能がすべて動作する状態に到達

---

### うまくいった点

#### 1. 助詞重複検出の大幅改善
**問題**: 「ということ」「といった」などの自然な複合助詞を誤検出

**解決策**: 例外パターンリストを実装
- ✅ **例外リスト追加**: [rule-engine.ts:33-46](c:\AI\writer\kotobalint\src\lib\rule-engine.ts#L33)
  - 12個の自然表現を定義（ということ、といった、では、でも、ので、など）
  - マッチ範囲の前後5文字コンテキストで判定

- ✅ **助詞「と」を完全除外**: [light-preset.yaml:16](c:\AI\writer\kotobalint\src\rules\presets\light-preset.yaml#L16)
  - 検出パターンから「と」を削除
  - 列挙表現（「AとBとC」）が誤検出されない

**テスト結果**:
```
✅ 「ということが大切」 → 検出なし（例外）
✅ 「AとBとC」 → 検出なし（と除外）
✅ 「私が私が行った」 → 1件検出（真の重複）
✅ 「を使用を推奨」 → 1件検出（真の重複）
```

#### 2. UIハイライト問題の完全解決
**問題**: issueが多いと全体が下線だらけで何もわからない

**解決策**: 選択issueのみをハイライト表示
- ✅ **実装変更**: [TextEditor.tsx:66-122](c:\AI\writer\kotobalint\src\components\TextEditor.tsx#L66)
  - **従来**: 全issueを常時ハイライト（カバレッジ配列方式）
  - **改善後**: 選択されたissueのみハイライト
  - 重要度別の色分け:
    - `info`: 青背景 + 青下線
    - `warn`: 黄背景 + 黄下線
    - `error`: 赤背景 + 赤下線

**効果**:
- issueが50個あっても、選択したもの以外はハイライトされない
- どのissueを見ているか一目瞭然
- パフォーマンス向上（DOM更新が最小限）

#### 3. issueクリック時の自動スクロール
- ✅ **スムーズスクロール**: [TextEditor.tsx:151-181](c:\AI\writer\kotobalint\src\components\TextEditor.tsx#L151)
  - issueをクリック → 該当箇所がエディタ中央に表示
  - `behavior: 'smooth'` でなめらかな移動
  - オーバーレイとテキストエリアの同期維持

#### 4. メタデータ表示の整理
- ✅ **内部データ非表示**: [IssueDetail.tsx:194-212](c:\AI\writer\kotobalint\src\components\IssueDetail.tsx#L194)
  - `originalText` など内部処理用フィールドをフィルタリング
  - ユーザー向け情報のみを「詳細情報」セクションに表示

#### 5. 不要ルールの削除
- ✅ **連続空白ルール削除**: [standard-preset.yaml:94-106](c:\AI\writer\kotobalint\src\rules\presets\standard-preset.yaml#L94) から削除
  - `\s{2,}` パターンが改行にも反応して誤検出
  - Standard プリセット: 18ルール → 17ルールに減少

#### 6. ヘッダーUIの大幅刷新
**問題**: ラジオボタンが古臭い、ボタンが2行に折り返されて見づらい

**解決策**: 2段レイアウト + モダンなタブUI
- ✅ **1段目**: ロゴ + タイトル（左）、設定ボタン（右）
- ✅ **2段目**: モードタブ + プリセット（左）、解析実行 + 一括修正（右）
- ✅ **タブデザイン**: [Header.tsx:135-172](c:\AI\writer\kotobalint\src\components\Header.tsx#L135)
  - Segmented Control（Pill Tabs）スタイル
  - `bg-slate-100` のコンテナに `bg-white shadow-sm` のアクティブタブ
  - `transition-all` でスムーズな切り替え

**モード別ボタン表示**: [Header.tsx:192-238](c:\AI\writer\kotobalint\src\components\Header.tsx#L192)
- **LLMモード**: 「AI提案」ボタン（電球アイコン）
- **ルールベースモード**: 「解析実行」ボタン（チェックアイコン）+ プリセット選択

#### 7. LLM issue管理の改善
**問題1**: `issues配列が長すぎます（最大10個）` エラー

**解決策**: [schema-validator.ts:55](c:\AI\writer\kotobalint\src\lib\schema-validator.ts#L55)
- `maxIssues: 10 → 30` に増加
- 長文（1000文字以上）でも対応可能

**問題2**: AI提案を複数回実行すると前のissueが残る

**解決策**: [actions.ts:114-118](c:\AI\writer\kotobalint\src\lib\actions.ts#L114)
```typescript
// 古いLLM issuesを削除してから新しいものを追加
const nonLLMIssues = issues.filter(issue => issue.source !== 'llm');
const allIssues = [...nonLLMIssues, ...response.issues];
setIssues(allIssues);
```

---

### 技術的な学び

#### 1. 正規表現による誤検出の回避策
**アプローチ比較**:
| アプローチ | メリット | デメリット |
|----------|---------|-----------|
| ネガティブルックアヘッド | パターン内で完結、高速 | 全例外を網羅する必要 |
| **例外リスト（採用）** | **拡張容易、メンテナンス性高** | 実行時チェック（軽微） |
| 形態素解析 | 最も正確 | 依存追加、パフォーマンス影響 |

**採用理由**: 拡張性とパフォーマンスのバランスが最適

#### 2. UIパフォーマンス最適化
**従来の問題点**:
```typescript
// 全文字位置に対してカバレッジ配列を作成
const cover: (string | null)[] = new Array(text.length).fill(null);
filteredIssues.forEach(issue => {
  for (let p = start; p < end; p++) {
    cover[p] = issue.severity; // O(text.length × issues.length)
  }
});
```

**改善後**:
```typescript
// 選択issueの範囲のみ処理
if (!selectedIssue) return plainText;
const html = text.slice(0, start) + highlighted + text.slice(end);
// O(1) 計算量
```

**効果**: 1000文字 × 50issues = 50,000回のループ → 不要に

---

### 現在の課題・今後の改善点

#### 1. UI/UXの細かい調整
- issueリストの選択状態が視覚的にわかりにくい
- エラーメッセージの表示方法改善
- ローディング状態の視覚的フィードバック強化
- レスポンシブデザインの調整（モバイル対応）

#### 2. ルール品質の検証と改善
- 実際の長文（1000文字以上）での動作確認
- 誤検出/見逃しの定量評価
- 助詞重複の例外パターンが十分かどうかの検証
- 新しいルールの追加検討

#### 3. パフォーマンス測定と最適化
- Standard/Strictプリセットでの実測値計測
- 目標値（Standard: 1-3秒、Strict: 3-5秒）との比較
- ボトルネック特定と最適化

#### 4. 機能拡張
- カスタムルールの追加機能
- ルールの有効/無効をUIから切り替え
- 一括修正の改善（プレビュー機能など）
- エクスポート機能（修正前後の比較レポート）

---

### ブランチ戦略
- **現在のブランチ**: `feature/textlint-integration`
- **作業内容**:
  - 助詞検出精度向上（例外リスト、「と」除外）
  - UI改善（ハイライト、スクロール、メタデータ、ヘッダー刷新）
  - LLM issue管理改善（制限緩和、重複修正）
  - 不要ルール削除

---

### 🎉 アプリ完成までの道のり

#### これまでの主要マイルストーン
1. **2025/10/01**: textlint統合開始、3段階プリセットシステム実装
2. **2025/10/02**: プリセット累積システム、LLM rationale最適化、UI統合
3. **2025/10/03**: 助詞検出精度向上、UIハイライト改善、ヘッダー刷新、**アプリ初版完成**

#### 完成した機能
- ✅ **2つの解析モード**: LLM（AI提案）/ ルールベース（Light/Standard/Strict）
- ✅ **17-32個のルール**: ら抜き言葉、助詞重複、冗長表現、文体統一など
- ✅ **インタラクティブUI**: issue選択、ハイライト、自動スクロール
- ✅ **一括修正機能**: 複数issueを一度に修正
- ✅ **モダンなデザイン**: タブUI、2段レイアウト、スムーズアニメーション

---

### 明日以降やれること（優先度順）

#### 🔥 優先度最高（すぐできる改善）
1. **issueリストの選択状態を目立たせる**
   - 選択中のissueに背景色やボーダーを追加
   - スクロール位置を選択issueに合わせる
   - 実装箇所: `IssueList.tsx` のスタイリング

2. **エラーメッセージの改善**
   - トースト通知や Alert コンポーネントで表示
   - エラー詳細を折りたたみ可能にする
   - 実装箇所: 新規 `ErrorBoundary` または `Toast` コンポーネント

3. **ローディング状態の改善**
   - スケルトンローディングの追加
   - プログレスバーの表示
   - 実装箇所: `TextEditor.tsx`, `IssueList.tsx`

#### ⚡ 優先度高（機能改善）
4. **実際の長文でのテスト**
   - 1000-3000文字の日本語文章で検証
   - 誤検出/見逃しをリスト化
   - 例外パターンや閾値の調整

5. **パフォーマンス計測**
   - 各プリセットの実行時間を記録
   - 1000文字、3000文字、5000文字での比較
   - `performance.now()` を使った詳細計測

6. **レスポンシブデザイン対応**
   - スマホ/タブレットでのレイアウト調整
   - ハンバーガーメニューの検討
   - Tailwind のブレークポイント活用

#### 📚 優先度中（ドキュメント・品質）
7. **ユーザーガイドの作成**
   - 各機能の使い方説明
   - ルールの説明と例
   - スクリーンショット付き

8. **README.md の整備**
   - セットアップ手順
   - 環境変数の説明
   - デプロイ方法

9. **テストの追加**
   - ルールエンジンのユニットテスト
   - UI コンポーネントのテスト
   - E2Eテスト（Playwright）

#### 🚀 優先度低（新機能）
10. **カスタムルール機能**
    - ユーザーが独自ルールを追加できる
    - YAML ファイルのアップロード機能
    - ルールエディタUI

11. **エクスポート機能**
    - 修正前後の比較レポート（PDF/Markdown）
    - 検出されたissueのCSVエクスポート
    - 修正履歴の保存

12. **設定のカスタマイズ**
    - 各ルールの有効/無効をUIから切り替え
    - 重要度の調整
    - カスタムプリセットの作成

13. **一括修正のプレビュー**
    - 修正前後の差分表示
    - 修正の取り消し機能
    - 選択的な一括修正

14. **デプロイと公開**
    - Vercel/Netlify へのデプロイ
    - カスタムドメインの設定
    - OGP画像の作成

---

### 技術的な深掘り候補

#### A. ルールエンジンの拡張
- 形態素解析（kuromoji.js）の導入で精度向上
- カスタム関数によるルール（正規表現以外）
- ルール間の依存関係管理

#### B. LLM最適化
- プロンプトエンジニアリングの改善
- ストリーミング応答の実装
- 複数LLMプロバイダー対応（OpenAI, Anthropic）

#### C. パフォーマンス最適化
- Web Worker でのルール実行
- インクリメンタル解析（変更部分のみ）
- キャッシュ戦略の改善

#### D. アクセシビリティ
- スクリーンリーダー対応
- キーボードショートカットの拡充
- WCAG 2.1 AA準拠

---

### 技術スタック（変更なし）
- **フロントエンド**: Next.js 14, React, TypeScript, Zustand
- **ルールエンジン**: YAML設定 + 正規表現
- **UI**: Tailwind CSS, Headless UI
- **API**: Next.js App Router (Route Handlers)

---

### リソース
- [textlint公式](https://textlint.github.io/)
- [Zennの校正ルール](https://github.com/zenn-dev/zenn-editor/tree/main/.textlintrc)
- [SmartHRの日本語ルール](https://github.com/kufu/textlint-rule-preset-smarthr)
