## kotobalint 引継ぎ資料 (2025/10/03)

### 今日のサマリ
- **助詞重複検出の精度向上**: 「ということ」などの自然表現を例外リストで除外
- **助詞「と」の検出除外**: 列挙表現（「AとBとC」）で頻出するため検出対象から削除
- **UI改善（ハイライト問題解決）**: 全issue常時表示 → 選択issueのみ表示に変更
- **UI改善（メタデータ整理）**: 内部用 `originalText` フィールドを非表示化
- **UI改善（自動スクロール）**: issueクリック時に該当箇所へスムーズスクロール
- **連続空白ルール削除**: 改行にも反応してしまうため Standard プリセットから削除

---

### うまくいった点

#### 1. 助詞重複検出の大幅改善
**問題**: 「ということ」「といった」などの自然な複合助詞を誤検出

**解決策**: 例外パターンリストを実装
- ✅ **例外リスト追加**: [rule-engine.ts:33-46](c:\AI\writer\kotobalint\src\lib\rule-engine.ts#L33)
  - 12個の自然表現を定義（ということ、といった、では、でも、ので、など）
  - マッチ範囲の前後5文字コンテキストで判定

- ✅ **助詞「と」を完全除外**: [light-preset.yaml:16](c:\AI\writer\kotobalint\src\rules\presets\light-preset.yaml#L16)
  - 検出パターンから「と」を削除
  - 列挙表現（「AとBとC」）が誤検出されない

**テスト結果**:
```
✅ 「ということが大切」 → 検出なし（例外）
✅ 「AとBとC」 → 検出なし（と除外）
✅ 「私が私が行った」 → 1件検出（真の重複）
✅ 「を使用を推奨」 → 1件検出（真の重複）
```

#### 2. UIハイライト問題の完全解決
**問題**: issueが多いと全体が下線だらけで何もわからない

**解決策**: 選択issueのみをハイライト表示
- ✅ **実装変更**: [TextEditor.tsx:66-122](c:\AI\writer\kotobalint\src\components\TextEditor.tsx#L66)
  - **従来**: 全issueを常時ハイライト（カバレッジ配列方式）
  - **改善後**: 選択されたissueのみハイライト
  - 重要度別の色分け:
    - `info`: 青背景 + 青下線
    - `warn`: 黄背景 + 黄下線
    - `error`: 赤背景 + 赤下線

**効果**:
- issueが50個あっても、選択したもの以外はハイライトされない
- どのissueを見ているか一目瞭然
- パフォーマンス向上（DOM更新が最小限）

#### 3. issueクリック時の自動スクロール
- ✅ **スムーズスクロール**: [TextEditor.tsx:151-181](c:\AI\writer\kotobalint\src\components\TextEditor.tsx#L151)
  - issueをクリック → 該当箇所がエディタ中央に表示
  - `behavior: 'smooth'` でなめらかな移動
  - オーバーレイとテキストエリアの同期維持

#### 4. メタデータ表示の整理
- ✅ **内部データ非表示**: [IssueDetail.tsx:194-212](c:\AI\writer\kotobalint\src\components\IssueDetail.tsx#L194)
  - `originalText` など内部処理用フィールドをフィルタリング
  - ユーザー向け情報のみを「詳細情報」セクションに表示

#### 5. 不要ルールの削除
- ✅ **連続空白ルール削除**: [standard-preset.yaml:94-106](c:\AI\writer\kotobalint\src\rules\presets\standard-preset.yaml#L94) から削除
  - `\s{2,}` パターンが改行にも反応して誤検出
  - Standard プリセット: 18ルール → 17ルールに減少

---

### 技術的な学び

#### 1. 正規表現による誤検出の回避策
**アプローチ比較**:
| アプローチ | メリット | デメリット |
|----------|---------|-----------|
| ネガティブルックアヘッド | パターン内で完結、高速 | 全例外を網羅する必要 |
| **例外リスト（採用）** | **拡張容易、メンテナンス性高** | 実行時チェック（軽微） |
| 形態素解析 | 最も正確 | 依存追加、パフォーマンス影響 |

**採用理由**: 拡張性とパフォーマンスのバランスが最適

#### 2. UIパフォーマンス最適化
**従来の問題点**:
```typescript
// 全文字位置に対してカバレッジ配列を作成
const cover: (string | null)[] = new Array(text.length).fill(null);
filteredIssues.forEach(issue => {
  for (let p = start; p < end; p++) {
    cover[p] = issue.severity; // O(text.length × issues.length)
  }
});
```

**改善後**:
```typescript
// 選択issueの範囲のみ処理
if (!selectedIssue) return plainText;
const html = text.slice(0, start) + highlighted + text.slice(end);
// O(1) 計算量
```

**効果**: 1000文字 × 50issues = 50,000回のループ → 不要に

---

### 現在の課題

#### 1. テストカバレッジ不足
- 助詞重複の例外パターンが本当に全ケースカバーしているか未検証
- エッジケース（例外が重複する場合など）のテストが必要

#### 2. ルール品質の検証
- 実際の長文（1000文字以上）での動作確認が不足
- 誤検出/見逃しの定量評価が必要

#### 3. パフォーマンス測定
- Standard/Strictプリセットでの実測値がない
- 目標値（Standard: 1-3秒、Strict: 3-5秒）の検証が必要

---

### ブランチ戦略
- **現在のブランチ**: `feature/textlint-integration`
- **作業内容**:
  - 助詞検出精度向上
  - UI改善（ハイライト、スクロール、メタデータ）
  - 不要ルール削除

---

### 次回やること（2025/10/04）

#### 優先度最高
1. **実テキストでの検証**
   - 1000文字以上の日本語文章で全プリセットをテスト
   - 誤検出/見逃しをリスト化
   - 必要に応じて例外リスト/ルールを調整

2. **パフォーマンス測定**
   - 各プリセットの実行時間を計測
   - 目標値との乖離を確認
   - ボトルネック特定（必要に応じて）

#### 優先度中
3. **UI細部の調整**
   - issueリストのスタイリング（選択中の視覚的フィードバック）
   - ハイライトの色/スタイル調整（ユーザビリティ向上）
   - エラーハンドリング強化

4. **ドキュメント整備**
   - ルールカタログの作成（各ルールの説明と例）
   - ユーザーガイドの作成

#### 優先度低
5. **機能拡張の検討**
   - カスタムルールの追加方法
   - ルールの有効/無効をUIから切り替え
   - 一括修正機能の改善

---

### 技術スタック（変更なし）
- **フロントエンド**: Next.js 14, React, TypeScript, Zustand
- **ルールエンジン**: YAML設定 + 正規表現
- **UI**: Tailwind CSS, Headless UI
- **API**: Next.js App Router (Route Handlers)

---

### リソース
- [textlint公式](https://textlint.github.io/)
- [Zennの校正ルール](https://github.com/zenn-dev/zenn-editor/tree/main/.textlintrc)
- [SmartHRの日本語ルール](https://github.com/kufu/textlint-rule-preset-smarthr)
