# kotobalint 引継ぎ資料 - 2025-09-26

## 今日の作業内容

### 🎯 主要な修正: ハイライト位置のズレ問題を根本解決

**問題**: LLM提案のハイライト位置が大幅にずれる（UTF-16コードユニットとグラフェム単位の違い）

**解決策**: LLMに位置を数えさせず、文脈検索でローカル決定する方式に完全移行

### 📝 実装した修正

#### 1. LLMスキーマの変更 (`src/lib/gemini-client.ts`)
- **削除**: `start`, `end` フィールド（位置情報）
- **追加**: `quote`, `before`, `after`, `nth` フィールド（文脈情報）
- LLMは位置を数えず、問題箇所の実体と前後文脈のみを返す

#### 2. テキスト正規化機能の実装
```typescript
function normalizeForMatch(s: string): string {
  // 改行統一 + NFKC正規化
  return s.replace(/\r\n?/g, '\n').normalize('NFKC');
}
```

#### 3. 位置マッピング機能の実装
```typescript
function buildIndexMaps(original: string) {
  // グラフェム単位とUTF-16コードユニットのマッピング
  // Intl.Segmenter を使用（フォールバック付き）
}
```

#### 4. 文脈検索による位置決定
```typescript
function findRangeByContext(
  raw: string, 
  before = '', 
  quote = '', 
  after = '', 
  nth = 1
): { start: number; end: number } | null
```

#### 5. プロンプトの更新
- インデックス返却を禁止
- `quote`: 問題箇所の実際の文字列
- `before`: 直前の文脈（最大40文字）
- `after`: 直後の文脈（最大40文字）
- `nth`: 同一quoteが複数ある場合の番号

#### 6. 位置補正ロジックの完全置換
- 旧: 正規表現パターンマッチング
- 新: 文脈検索ベースの位置決定

### 🔧 技術的詳細

#### 問題の根本原因
- **UTF-16コードユニット**: JavaScript文字列のインデックス単位
- **グラフェム単位**: 視覚的な文字単位（絵文字、合成文字、濁点結合など）
- LLMはグラフェム単位で数えるが、JavaScriptはUTF-16で処理

#### 解決アプローチ
1. **LLMに位置を数えさせない**
2. **文脈情報でアンカーを取得**
3. **ローカルで正規化テキスト上で検索**
4. **UTF-16オフセットに逆変換**

### 📊 修正結果

#### 修正前の問題
- 表記ゆれ: 位置が13-19文字目にずれ
- ら抜き言葉: 位置が13-19文字目にずれ（実際は48-52文字目）
- ハイライトが全く表示されない

#### 修正後の期待結果
- 正確な位置検出
- 正しいハイライト表示
- 改行・合成文字・絵文字に対応

### 🚀 次のステップ

#### 即座にテストすべき項目
1. **基本機能テスト**
   - 元のテスト文章でのAI提案
   - ハイライト表示の確認
   - 位置情報の正確性

2. **エッジケーステスト**
   - 絵文字を含む文章
   - 合成文字（濁点結合など）
   - 長い文章での位置検出

3. **パフォーマンステスト**
   - 文脈検索の速度
   - メモリ使用量

#### 今後の改善案
1. **デバッグログの追加**
   - 文脈検索の成功/失敗ログ
   - 位置決定の詳細ログ

2. **エラーハンドリングの強化**
   - 文脈検索失敗時のフォールバック
   - 位置決定失敗時の警告表示

3. **UI改善**
   - ハイライトの視覚的改善
   - 位置情報のデバッグ表示

### ⚠️ 注意事項

#### 既知の制限
- `Intl.Segmenter` が利用できない環境では文字単位で処理
- 非常に長い文章では位置マッピングの精度が下がる可能性

#### 互換性
- 既存のルールベース解析は影響なし
- LLM提案のみが新しい方式を使用

### 📁 変更ファイル
- `src/lib/gemini-client.ts`: 完全書き換え
  - スキーマ変更
  - 正規化機能追加
  - 文脈検索機能追加
  - 位置補正ロジック置換

### 🎉 期待される効果
- **ハイライト位置の完全修正**
- **絵文字・合成文字への対応**
- **改行統一による安定性向上**
- **位置検出の高精度化**

---

**作業者**: AI Assistant  
**日時**: 2025-09-26  
**ステータス**: 実装完了、テスト待ち
