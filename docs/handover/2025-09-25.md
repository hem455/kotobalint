## kotobalint 引継ぎ資料 (2025/09/25)

### プロジェクト概要
- 日本語テキストのルールベース校正 + LLM提案プレビューを提供する Next.js アプリ。
- 通常解析は `src/lib/rule-engine.ts`（YAML: `src/rules/japanese-standard-rules.yaml`）。
- LLM提案は API `/api/suggest` → `src/lib/gemini-client.ts` で生成、クライアントは `src/lib/actions.ts` で取り扱い。

### 今日の主な変更点
- タイトルを「kotobalint」に統一（`src/app/page.tsx`, `src/components/Header.tsx`）。
- ルール強化: ら抜き（`食べれる`）等を YAML に明示。表記ゆれ（コンピュータ/コンピューター）も検出。
- LLM提案のハイライトずれ対策: `gemini-client.ts` に `CORRECTION_PATTERNS` + `findTextPosition` 実装。LLM が返す range 近傍±50 で再スキャンし、実テキスト一致にスナップ。
- LLM提案は「プレビュー専用」へ変更: `src/lib/store.ts`, `src/components/IssueDetail.tsx` で適用ボタンを無効化（ルール由来のみ適用可）。
- 通常解析の再実行時、既存の LLM 問題を保持するよう `src/lib/actions.ts` を修正（上書きで消えない）。
- シークレット検知を精度改善: `src/lib/secret-guard.ts` を単一定義にリファクタ、運転免許証はキーワード近傍の 12 桁のみ検出（誤検出削減）。
- ルールファイル読み込みを完全非同期化: `src/lib/rule-manager.ts`。
- LLM失敗時のフォールバック: `/api/suggest` は 200 + 空 issues を返却（UI 不全を回避）。

### 起動・再起動
- 開発サーバー: `npm run dev`（http://localhost:3000）。
- 反映が必要な変更後（YAML/サーバ側ロジック）: サーバー再起動。
- ログに出る確認メッセージ:
  - `ルールファイルパスを解決しました:`
  - `ルールファイルを正常に読み込みました:`

### 仕様メモ
- ルール由来の Issue: 「適用」可能。`issue.source === 'rule'`。
- LLM由来の Issue: プレビューのみ。`issue.source === 'llm'` は適用不可。
- 再解析時: ルール結果に既存 LLM 問題をマージして保持。
- LLM の位置補正: `CORRECTION_PATTERNS` でメッセージ/近傍/全体の順に検索→最初の一致を `range` として補正。

### 手動テスト手順（抜粋）
1) 表示確認: トップに「kotobalint」、エディタ表示。
2) 通常解析: 「食べれる」「コンピュータ/コンピューター」を含む文で検出されること。
3) LLM提案: 同文で提案が追加表示されること。ハイライト位置が実テキストと一致。
4) 提案適用: ルール由来のみ適用でき、LLM由来は適用できない（ボタン非表示/無効）。
5) 再解析: LLM提案が消えずに保持されること。
6) シークレット検知: 「免許番号 123456789012」はブロック、単独の `123456789012` は許可。

### トラブルシューティング
- LLM提案が 500 になる: `/api/suggest` はフォールバックで 200 + 空の issues を返却。UI 側で通知（meta.notice）。
- ルールが効かない: YAML を修正後はサーバー再起動必須。
- 位置ずれ: `gemini-client.ts` の `CORRECTION_PATTERNS` にパターン追加で改善可能。

### 主要ファイル
- ルール: `src/rules/japanese-standard-rules.yaml`
- ルール適用: `src/lib/rule-engine.ts`
- ルール読み込み: `src/lib/rule-manager.ts`
- LLM クライアント: `src/lib/gemini-client.ts`
- LLM API: `src/app/api/suggest/route.ts`
- ストア: `src/lib/store.ts`
- 画面: `src/app/page.tsx`, `src/components/*`

### 今後の改善候補
- LLM提案からルール化への昇格フロー（ユーザ承認→YAML更新までのUI）。
- `CORRECTION_PATTERNS` の外部定義化（設定画面から増減）。
- ルール側の自動修正候補の複数提示/順位付け。

以上。


